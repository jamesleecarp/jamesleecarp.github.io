<!doctype html>
<html>
<!--
 * Demonstrates how to add a subset of shapefile features to a map
 * Adapted from https://code.google.com/p/gmaps-samples/source/browse/trunk/shapefileloader/?r=2692, authored by Mano Marks, Google
 * 
-->

  <head>
    <meta charset="utf-8">
    <title>Shapefile Subset Example</title>
    <link rel="stylesheet" type="text/css" href="../assets/jquery-easyui/themes/default/easyui.css">
	<style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0px; padding: 0px }
	  #map { height: 100% }
      input { margin: 5px }
      #msg { font-size: large }
    </style>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="../assets/jquery-easyui/jquery.easyui.min.js"></script>
  </head>
  <body class="easyui-layout">
    <div id="map" data-options="region:'center',split:true"></div>
    <div data-options="region:'east',split:true" title="County Viewer" style="width:230px;">
      <fieldset>
        <label>Pick a state:<br /> <select id="states"></select></label><br />
        <input type="button" id="btnShow" value="Show" onclick="process()" />
        <input type="button" id="btnClear" value="Clear" onclick="clearMap()" />
      </fieldset>
      <table id="sidebar" class="easyui-datagrid" rownumbers="true" sortName="county" sortOrder="asc" remoteSort="false" 
        striped="true" singleSelect="true">
        <thead>
          <tr>
            <th data-options="field:'id',sortable:true,hidden:true">ID</th>
            <th data-options="field:'county',sortable:true">Name</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div id="msg"></div>
    </div>
    <script src="assets/js/dbf.js"></script>
    <script src="assets/js/shp.js"></script>
    <script type="text/javascript">
      var map;
      var shpfile;
      var shp
      var dbf;
      var infoWindow;
      var counties;
      
      var arrStates = {
          'AL' : 'Alabama', 'AK' : 'Alaska', 'AZ' : 'Arizona'
      };

      var select = $('#states');
      if(select.prop) {
        var options = select.prop('options');
      } else {
        var options = select.attr('options');
      }
      $('option', select).remove();

      $.each(arrStates, function(val, text) {
        options[options.length] = new Option(text, val);
      });
      
      // Creates the map, loads in the SHP and DBF files.
      function initMap() {
        infoWindow = new google.maps.InfoWindow();
        counties = [];
        
        $('#msg').text('Please wait while loading data...');
        $('#btnShow').prop("disabled",true);
        $('#btnClear').prop("disabled",true);
        
        if (!google.maps.Polygon.prototype.getBounds) {
          google.maps.Polygon.prototype.getBounds = function(poly) {
              var bounds = new google.maps.LatLngBounds();
              var paths = this.getPaths();
              var path;
              for (var p = 0; p < paths.getLength(); p++) {
                  path = paths.getAt(p);
                  for (var i = 0; i < path.getLength(); i++) {
                      bounds.extend(path.getAt(i));
                  }
              }
              return bounds;
          }
        }      
        
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 5,
          center: new google.maps.LatLng(39.3, -95.8),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
		
        shpfile = 'assets/data/counties';

        SHPParser.load(shpfile + '.shp', shpLoad, shpLoadError);
        DBFParser.load(shpfile + '.dbf', dbfLoad, dbfLoadError);
      }

      // Handles the callback from loading DBFParser by assigning the dbf to a global.
      function dbfLoad(db) {
        dbf = db;
        if (dbf && shp) {
          enableForm();
        }
      }

      // Handles the callback from loading SHPParser by assigning the shp to a global.
      function shpLoad(sh) {
        shp = sh;
        if (dbf && shp) {
          enableForm();
        }
      }

      function enableForm() {
        $('#msg').text('');
        $('#btnShow').prop("disabled",false);
        $('#btnClear').prop("disabled",false);
      }      
      
      function myclick(num) {
        // Empty braces fix "b is undefined" error per
        // http://stackoverflow.com/questions/19665773/google-maps-b-is-undefined-when-simulating-polygon-clicks
        google.maps.event.trigger(counties[num], "click", {} );
      }
           
	  function process() {      
		var selState = $('#states').val();
		render(selState);
	  }
	  
      // Adds counties for specified state
      function render(state) {   
        clearMap();
        
        var bounds = new google.maps.LatLngBounds();
        var points;

        for (var i = 0; i < shp.records.length; i++) {
          var cnty_dbf = dbf.records[i];
 
          if (cnty_dbf["STATE_ABBR"] == state) {
            stage = 1;
            var name = cnty_dbf['NAME'];
            var shape = shp.records[i].shape;
            var overlay;
            var polygonPoints = [];
            var parts = shape.content.parts;
              
            if (parts.length === 1) {
              polygonPoints.push(pathToArray(shape.content.points));
            } else {
              var j;
              for (j = 0; j < parts.length - 1; j++) {
                polygonPoints.push(pathToArray(shape.content.points.subarray(2 * parts[j], 2 * parts[j + 1])));
                if (2 * parts[j + 1] > shape.content.points.length) {
                  throw new Error('part index beyond points array end');
                }
              }
            }
                  
            // create a polygon.
            var polygon = new google.maps.Polygon({
              strokeWeight: .3,
              fillOpacity: .2,
              paths: polygonPoints,
              map: map
            });
            
            counties[i] = polygon;

            bounds.union(polygon.getBounds());
            
            var htmlContent = recordHtmlContent(dbf.records[i]);
			
            handle_clicks(polygon, htmlContent);
            
            addToSidebar(name, i);
          }
        }
        
        $('#sidebar').datagrid({
          onClickRow: function(index,row){
            myclick(row.id);
          }
        });
        
        map.fitBounds(bounds);
      }

      function addToSidebar(name, i) {
        // This method doesn't work
        // $('#sidebar').datagrid('appendRow',{ id: i, county: name });
        
        var lastRow = $('<tr/>').appendTo($("#sidebar").find('tbody:last'));
        lastRow.append($('<td/>').text(i)); 
        lastRow.append($('<td/>').text(name)); 
      }
      
      function handle_clicks(overlay, info) {
        google.maps.event.addListener(overlay, 'click', function(e) {
          if (typeof infoWindow != 'undefined') {
            infoWindow.close();
          }
                    
          infoWindow.setContent(info);
          infoWindow.setPosition(overlay.getBounds().getCenter());
          infoWindow.open(map);           
        });
      }
				
      // Format shapefile attribute data for info window
      function recordHtmlContent(record) {
        var content = '';
        for (var key in record) {
          content += '<b>' + key + '</b>: ' + record[key] + '<br>';
        }
        return content;
      }

      /* Create an Array out of a set of points ordered longitude/latitude
       * @param {array} path an array of points.
       */
      function pathToArray(path) {
		var polygonPoints = [];
		for (var i = 0; i < path.length; i += 2) {
          polygonPoints.push(new google.maps.LatLng(path[i + 1], path[i]));
        }
        return polygonPoints;
      }
	  
      function clearMap() {
        if (typeof infoWindow != 'undefined') {
          infoWindow.close();
        }
        
        var rows = $('#sidebar').datagrid('getRows');
      
		for (var i = 0; i < rows.length; i++){
          var id = rows[i].id;
          counties[id].setMap(null);
		}

        // Need to do both of these, not sure why
        $('#sidebar').datagrid('loadData', {"total":0,"rows":[]});
        $('#sidebar tr').remove();
      }
      
      // error handler for shploader.
      function shpLoadError() {
        window.console.log('shp file failed to load');
      }

      // error handler for dbfloader.
      function dbfLoadError() {
        console.log('dbf file failed to load');
      }
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQD9y5K9N-fQZ40jwFbXpBKcbjXxvbDow&callback=initMap">
    </script>
  </body>
</html>